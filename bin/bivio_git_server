#!/bin/bash
#
# Start a read-only git server in ~/src on port 10$(id -u).
#
# The server listens on all addresses so it could potentially be open to the world, but
# high ports are usually blocked by the firewall.
#
# It serves raw content like github by creating a directory (~/.bivio_git_server) with
# symlinks into ~/src. Also calls git update-server-info, because this is required
# by git.
#
host=127.0.0.1
port=$(printf '10%03d' "$(id -u)")

case $1 in
    -port)
        if ! (exec > "/dev/tcp/$host/$port") 2>/dev/null; then
            echo 'Read-only git server is not running' 1>&2
            echo "Start with: $0" 1>&2
            exit 1
        fi
        echo "$port"
        exit 0
        ;;
    -*)
        echo "Usage: $0 [-docker-url|-vagrant-url]" 1>&2
        exit 1
        ;;
    *)
        ;;
esac

cd
rm -rf .bivio_git_server
mkdir -p .bivio_git_server
cd .bivio_git_server
root_dir=$(pwd)
mkdir -p repo conf
repo_dir=$root_dir/repo
conf_dir=$root_dir/conf

cd "$repo_dir"
for git in "$HOME"/src/*/*/.git; do
    (cd $git; git update-server-info)
    r=$(dirname "${git#$HOME/src/}")
    mkdir -p "$r"
    ln -s "$git" "$r.git"
    raw=$(dirname "$git")
    for channel in alpha beta stable master; do
        ln -s "$raw" "$r/$channel"
    done
done

cd $conf_dir
cat > httpd.conf <<EOF
LoadModule mime_module modules/mod_mime.so
LoadModule dav_module modules/mod_dav.so
LoadModule dav_fs_module modules/mod_dav_fs.so
LoadModule authz_host_module modules/mod_authz_host.so
LoadModule log_config_module		modules/mod_log_config.so
LoadModule logio_module		modules/mod_logio.so

Listen $port
User $USER
Group $USER
ServerAdmin $USER
ServerRoot $conf_dir
ServerName localhost.localdomain
ErrorLog |cat
LogFormat "%{host}i %h %P %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
CustomLog |cat combined
TypesConfig /etc/mime.types
LockFile httpd.lock
KeepAlive off
LimitRequestBody 0

<Directory />
    AllowOverride None
    Order deny,allow
    Deny from all
</Directory>

<VirtualHost *>
    DocumentRoot $repo_dir
    <Location />
        Options MultiViews Indexes IncludesNoExec SymLinksIfOwnerMatch
        Dav On
        <Limit HEAD GET OPTIONS PROPFIND>
           Order allow,deny
           Allow from all
        </Limit>
        <LimitExcept HEAD GET OPTIONS PROPFIND>
            Order deny,allow
            Deny from all
        </LimitExcept>
    </Location>
</VirtualHost>
EOF

ln -s /etc/httpd/modules .
ln -s . run
echo read-only git server "http://$host:$port" serving "$HOME"/src
exec /usr/sbin/httpd -f "$conf_dir/httpd.conf" -d "$conf_dir" -X
