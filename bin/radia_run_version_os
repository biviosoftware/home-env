#!/bin/bash
#
# Outputs a token that describes the operating system version: darwin-12.5.1, arch, fedora32, etc.
# If there is no version (e.g. arch linux), then it is just the os name.
#
set -eou pipefail

_sep=-

bivio_os_version_linux() {
    declare i r
    if [[ -r /etc/os-release ]] && source /etc/os-release >&/dev/null && [[ ${ID:-} ]]; then
        i=$ID
        r=$VERSION_ID
    elif type -p lsb_release >& /dev/null; then
        declare i=$(lsb_release -s -i)
        declare r=$(lsb_release -s -r)
    fi
    if [[ ! ${i:-} && -r /etc/lsb-release ]] && source /etc/lsb-release; then
        i=$DISTRIB_ID
        r=$DISTRIB_RELEASE
    fi
    if [[ ! ${i:-} ]]; then
        return 1
    fi
    echo "$i${r:+$_sep$r}"
    return 0
}

bivio_os_version_main() {
    case $(uname -s) in
        Linux)
            if bivio_os_version_linux; then
                return
            fi
            ;;
        Darwin)
            echo "darwin$_sep$(sw_vers -productVersion)"
            return
            ;;
        *)
            ;;
    esac
    echo unknown
}

bivio_os_version_main "$@"
