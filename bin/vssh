#!/usr/bin/env bash
#
# Cache how vagrant makes the ssh connection, because at least 3 seconds faster
# since don't have to startup Ruby.
#
if [[ ! -f .vssh || ~/.vagrant.d/data/machine-index/index -nt .vssh ]]; then
    vagrant ssh -c 'sleep 2' </dev/null &>/dev/null &
    p=$!
    declare -i i=0
    while (( $i < 6 )); do
        x="$(ps axww | grep " ssh vagrant@.*$(pwd)"| grep -v ' grep ')"
        if [[ $x ]]; then
            break
        fi
        sleep 1
        i+=1
    done
    if [[ $(wait "$p") ]]; then
        # Something went wrong, show the user the error, don't write .vssh
        exec vagrant ssh
    fi
    if [[ $x ]]; then
        #TODO(robnagler): Does not work with spaces in the directory name
        x=${x#* ssh }
        x="ssh ${x% -t bash -l*}"
        x=${x/LogLevel=FATAL/LogLevel=ERROR}
    else
        x='vagrant ssh'
    fi
    echo "exec $x" > .vssh
fi
. ./.vssh
